import React, { useState, useEffect } from 'react'
import { View, ActivityIndicator, StyleSheet } from 'react-native'
import { RoundedContainer, SafeAreaView } from '@components/containers'
import { NavigationHeader } from '@components/Header'
import SearchContainer from '@components/containers/SearchContainer'
import { ProductsList } from '@components/Product'
import { fetchProducts } from '@api/services/generalApi'
import { FlashList } from '@shopify/flash-list'
import { formatData } from '@utils/formatters'
import { Loader } from '@components/Loader'
import { debounce } from 'lodash';
import { useIsFocused, useFocusEffect } from '@react-navigation/native'

const ProductsScreen = ({ navigation }) => {
  const [searchText, setSearchText] = useState('')

  const [products, setProducts] = useState([]);
  const [offset, setOffset] = useState(0);
  console.log("ðŸš€ ~ ProductsScreen ~ offset:", offset)
  const [loading, setLoading] = useState(false);
  const [allDataLoaded, setAllDataLoaded] = useState(false);
  const isFocused = useIsFocused();

  // useEffect(() => {
  //   fetchInitialProducts();
  // }, []);


  const fetchInitialProducts = async () => {
    console.log('Fetch initaial products')
    setLoading(true);
    try {
      const fetchedProducts = await fetchProducts({ searchText: searchText, offset: 0, limit: 20 });
      setProducts(fetchedProducts);
    } catch (error) {
      console.error('Error fetching products:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchMoreProducts = async () => {
    console.log('Fetch more products')
    if (loading || allDataLoaded) return;
    setLoading(true);
    try {
      const fetchedProducts = await fetchProducts({searchText:searchText, offset, limit: 20 });
      if (fetchedProducts.length === 0) {
        setAllDataLoaded(true);
      } else {
        setProducts([...products, ...fetchedProducts]);
        setOffset(offset + 1);
      }
    } catch (error) {
      console.error('Error fetching more products:', error);
    } finally {
      setLoading(false);
    }
  };

  useFocusEffect(
    React.useCallback(() => {
      setOffset(0);
      setProducts([]);
      fetchInitialProducts();
      fetchMoreProducts()
    }, [searchText])
  );

  useEffect(() => {
    if (isFocused) {
      fetchInitialProducts();
    }
  }, [isFocused]);

  const renderItem = ({ item }) => {
    if (item.empty) {
      return <View style={[styles.itemStyle, styles.itemInvisible]} />
    }
    return (
      <ProductsList item={item} onPress={() => console.log('Product selected:', item)} />
    )
  }
  return (
    <SafeAreaView>
      {/* NavigationHeader component for displaying the screen title and a back button */}
      <NavigationHeader
        title="Products"
        onBackPress={() => navigation.goBack()}
      />
      <SearchContainer placeholder='Search Products' onChangeText={setSearchText} />

      <RoundedContainer>
        <FlashList
          data={formatData(products, 3)}
          numColumns={3}
          renderItem={renderItem}
          keyExtractor={(item, index) => index.toString()}
          contentContainerStyle={{ padding: 10, paddingBottom: 50 }}
          onEndReached={fetchMoreProducts}
          showsVerticalScrollIndicator={false}
          onEndReachedThreshold={0.2}
          // ListFooterComponent={loading && <ActivityIndicator size="large" color="#0000ff" />}
          ListFooterComponent={loading && <Loader visible={loading} animationSource={require('@assets/animations/loading.json')} />}
        />
      </RoundedContainer>
    </SafeAreaView>
  )
}

export default ProductsScreen


const styles = StyleSheet.create({
  itemInvisible: {
    backgroundColor: 'transparent',
  },
  itemStyle: {
    flex: 1,
    alignItems: 'center',
    margin: 6,
    borderRadius: 8,
    marginTop: 5,
    backgroundColor: "white",
  },
});


latest--------------------------------------___>
import React, { useState, useEffect, useCallback } from 'react';
import { View, ActivityIndicator, StyleSheet } from 'react-native';
import { RoundedContainer, SafeAreaView, SearchContainer } from '@components/containers';
import { NavigationHeader } from '@components/Header';
import { ProductsList } from '@components/Product';
import { fetchProducts } from '@api/services/generalApi';
import { FlashList } from '@shopify/flash-list';
import { formatData } from '@utils/formatters';
import { Loader } from '@components/Loader';
import { useIsFocused, useFocusEffect } from '@react-navigation/native';

const ProductsScreen = ({ navigation }) => {
  const [products, setProducts] = useState([]);
  const [offset, setOffset] = useState(0);
  const [searchText, setSearchText] = useState('');
  const [loading, setLoading] = useState(false);
  const [allDataLoaded, setAllDataLoaded] = useState(false);
  const isFocused = useIsFocused();

  useFocusEffect(
    useCallback(() => {
      setOffset(0);
      setProducts([]);
      fetchInitialProducts();
    }, [searchText])
  );

  useEffect(() => {
    if (isFocused) {
      fetchInitialProducts();
    }
  }, [isFocused]);

  const fetchInitialProducts = useCallback(async () => {
    console.log('Fetch initial products');
    setLoading(true);
    try {
      const fetchedProducts = await fetchProducts({ offset: 0, limit: 20, searchText });
      setProducts(fetchedProducts);
    } catch (error) {
      console.error('Error fetching products:', error);
    } finally {
      setLoading(false);
    }
  }, [searchText]);

  const fetchMoreProducts = async () => {
    console.log('Fetch more products');
    if (loading || allDataLoaded) return;
    setLoading(true);
    try {
      const fetchedProducts = await fetchProducts({ offset, limit: 20, searchText });
      if (fetchedProducts.length === 0) {
        setAllDataLoaded(true);
      } else {
        setProducts([...products, ...fetchedProducts]);
        setOffset(offset + 1);
      }
    } catch (error) {
      console.error('Error fetching more products:', error);
    } finally {
      setLoading(false);
    }
  };

  const debouncedSearch = useCallback(
    debounce((text) => {
      setSearchText(text);
    }, 1000),
    []
  );

  const handleSearchTextChange = (text) => {
    debouncedSearch(text);
  };

  const renderItem = ({ item }) => {
    if (item.empty) {
      return <View style={[styles.itemStyle, styles.itemInvisible]} />;
    }
    return <ProductsList item={item} onPress={() => console.log('Product selected:', item)} />;
  };

  return (
    <SafeAreaView>
      {/* NavigationHeader component for displaying the screen title and a back button */}
      <NavigationHeader title="Products" onBackPress={() => navigation.goBack()} />
      <SearchContainer placeholder="Search Products" onChangeText={handleSearchTextChange} />
      <RoundedContainer>
        <FlashList
          data={formatData(products, 3)}
          numColumns={3}
          renderItem={renderItem}
          keyExtractor={(item, index) => index.toString()}
          contentContainerStyle={{ padding: 10, paddingBottom: 50 }}
          onEndReached={fetchMoreProducts}
          showsVerticalScrollIndicator={false}
          onEndReachedThreshold={0.2}
          ListFooterComponent={loading && <Loader visible={loading} animationSource={require('@assets/animations/loading.json')} />}
        />
      </RoundedContainer>
    </SafeAreaView>
  );
};

export default ProductsScreen;

const styles = StyleSheet.create({
  itemInvisible: {
    backgroundColor: 'transparent',
  },
  itemStyle: {
    flex: 1,
    alignItems: 'center',
    margin: 6,
    borderRadius: 8,
    marginTop: 5,
    backgroundColor: 'white',
  },
});

function debounce(func, wait) {
  let timeout;
  return function (...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      func.apply(context, args);
    }, wait);
  };
}
